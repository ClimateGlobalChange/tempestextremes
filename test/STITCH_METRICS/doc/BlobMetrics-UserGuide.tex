\documentclass{article}

\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{multicol}
\usepackage{color}
\usepackage{comment}

\oddsidemargin 0cm
\evensidemargin 0cm

\textwidth 16.5cm
\topmargin -2.0cm
\parindent 0cm
\textheight 24cm
\parskip 0.5cm

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
%\fancyhead[L]{AOSS Reference Sheet}
%\fancyhead[CH]{test}
\fancyfoot[C]{Page \thepage}

\begin{document}
{\Huge \textbf{BlobMetrics: an analysis framework for StitchBlobs outputs}}
\tableofcontents

\pagebreak

\section{Minimum Requirements}
\begin{itemize}
\item R software (\texttt{https://www.r-project.org/}) and the following libraries:
\begin{itemize}
\item abind
\item argparse
\item RNetCDF (\texttt{https://journal.r-project.org/archive/2013/RJ-2013-023/RJ-2013-023.pdf})
\end{itemize}
\item StitchBlobs output (in the form of NetCDF files)
\item BlobStats output (in the form of text files)
\end{itemize}

If the required libraries have not yet been installed in R, then an internet connection will be necessary, as R will attempt to download the missing libraries from online repositories before running the code.

\section{Usage}
The main control framework is run from the command line, with the following syntax:
\begin{verbatim}
Rscript --vanilla stitch_metric_framework.R [flags]
\end{verbatim}

In order to view all possible options, run the above command with the \texttt{-h} or \texttt{--help} flag:
\begin{verbatim}
Rscript --vanilla stitch_metric_framework.R -h
\end{verbatim}

which will print out the list of optional flags and exit. These flags will be explained further in subsequent sections.

These various tools can also be utilized in an interactive R session by opening R and loading the various functions from the source R scripts. For example, to read a list of BlobStats files into a single data table, type the following commands into R:

\begin{verbatim}
source("read_stitch.R")
file_list<-"list_of_blobfiles.txt"
table_stats<-read_stats_to_table(file_list,6,var="TM90")
\end{verbatim}

The \texttt{source} command reads in all of the commands from the R script \texttt{read\_stitch.R}, which loads the function \texttt{read\_stats\_to\_table}. This function takes an existing text file (\texttt{list\_of\_blobfiles.txt}) containing a list of BlobStats file names, and reads all of those files into a data frame that is named \texttt{table\_stats}. \texttt{6} refers to the number of hours per time step in the original data and \texttt{TM90} refers to the block detection algorithm (Tibaldi and Molteni 1990) that was used to produce input files for StitchBlobs. 

\section{Read BlobStats files into a single table}
This utility takes each BlobStats file and reads the information into a single combined data frame. The columns of the data frame depend upon the included variables in the BlobStats output. Possible variables include \texttt{minlat, minlon, maxlat, maxlon, centlat, centlon,} and \texttt{area} and are specified when running BlobStats. There is optional functionality to save the output to one of three file types (RData, text, or CSV).

\subsection{Command line syntax}
\begin{verbatim}
Rscript --vanilla stitch_metric_framework.R [-rf] [-fn or -fl FILE] [-th TIMERES] 

(optional)
[-an ALGORITHM] [--rtable OUTPUT] [--texttable OUTPUT] [--csvtable OUTPUT]
\end{verbatim}

The following flags are required:
\begin{itemize}
\item[] \texttt{-rf} (\texttt{--readfiles}) \\ Tell program to read in BlobStats data
\item[]\texttt{-fn} (\texttt{--filename}) or \texttt{-fl} (\texttt{--filelist}) \texttt{FILE}\\ Name of single input BlobStats output, or a text file containing a list of BlobStats file names.
\item[]\texttt{-th} (\texttt{--thourly}) \texttt{TIMERES}\\ Time resolution in terms of hours (i.e. 6 for 6 hourly)
\end{itemize}

The following flags are optional:
\begin{itemize}
\item[]\texttt{-an} (\texttt{--algname}) \texttt{ALGORITHM}\\ Name of the objective blocking detection algorithm used to produce input files for StitchBlobs. Recommended to use this flag if you will be looking at outputs from multiple algorithms, as it will help to differentiate between datasets if you combine multiple data frames into a single file (see Section \ref{combinetable}).
\item[] \texttt{--rtable OUTPUT}\\ File name for output RData file. The result will be an RData table containing the data frame \texttt{df\_tot}.
\item[] \texttt{--texttable OUTPUT}\\ File name for output text file with tab-separated columns.
\item[] \texttt{--csvtable OUTPUT}\\File name for output CSV file. 
\end{itemize}
\subsection{Function syntax}

To load and use  this function in an interactive R session, do
\begin{verbatim}
source("read_stitch.R")
desired_name<-read_stats_to_table(flist,nhrs,..)
\end{verbatim}

which will produce a \texttt{data.frame} object with the variable name \texttt{desired\_name}.

The following arguments are required:
\begin{itemize}
\item[] \texttt{flist}\\ a vector object containing the BlobStats file names.
\item[] \texttt{nhrs}\\ Time resolution in terms of hours (i.e. 6 for 6 hourly)
\end{itemize}

The following arguments are optional:
\begin{itemize}
\item[] \texttt{var}\\ Name of the objective blocking detection algorithm used to produce input files for StitchBlobs. If left blank, a column \texttt{var} will be filled with the string \texttt{VAR}
\item[] \texttt{rfn, textfn, csvfn}\\Strings specifying output file names for RData, text, and CSV file formats. If left blank, the function will merely return the \texttt{data.frame} object to the console.
\end{itemize}

\subsection{Output}\label{tableoutput}

An example output data table looks like this in the R console:
\begin{verbatim}
             datehour minlat maxlat minlon maxlon centlat centlon    area  area_km bnum var
1 1980-12-01 00:00:00     50     72    187    218    61.0   202.5 0.08299 42330251    1 TM90
2 1980-12-01 06:00:00     50     74    187    222    62.0   204.5 0.08980 45803790    1 TM90

                           file
1   ERA_1980_DJF_NP_Z_stats.txt
2   ERA_1980_DJF_NP_Z_stats.txt
\end{verbatim}

\begin{itemize}
\item[]\texttt{datehour}\\The date string in the format \texttt{YYYY-MM-DD-HH}
\item[] \texttt{minlat, maxlat, minlon, maxlon, centlat, centlon}\\ Latitude and longitude coordinates for the block's extent and centroid
\item[] \texttt{area}\\ Fractional area of the block
\item[] \texttt{area\_km}\\area of the block in km$^2$
\item[] \texttt{var}\\ Algorithm name specified either by the \texttt{-an} flag in the console or \texttt{var} in the function (default \texttt{VAR})
\item[] \texttt{bnum} \\The blob ID number as specified in the BlobStats file
\item[] \texttt{file} \\name of the BlobStats file which contains the specified blob information
\end{itemize}

\section{Read previously created data table(s) into an R session}\label{combinetable}
This utility reads previously created data tables into the R session, combining tables into one single table. This function is particularly useful if attempting to examine data from multiple detection algorithms. There is optional functionality to save the output to one of three file types (RData, text, or CSV).
\subsection{Command line syntax}
\begin{verbatim}
Rscript --vanilla stitch_metric_framework.R [-rt] [-fn or -fl FILE] 
[--isr or --istext or --iscsv]


(optional)
[--rtable OUTPUT] [--texttable OUTPUT] [--csvtable OUTPUT]
\end{verbatim}

The following flags are required:
\begin{itemize}
\item[] \texttt{-rt} (\texttt{--readtable}) \\ Tell program to read in BlobStats data
\item[]\texttt{-fn} (\texttt{--filename}) or \texttt{-fl} (\texttt{--filelist}) \texttt{FILE}\\ Name of single file containing output from \texttt{--readfiles}, or a text file containing a list of files with output from \texttt{--readfiles}.
\item[]\texttt{--isr}\\Boolean telling the program that the input is in RData format
\item[]\texttt{--istext}\\Boolean telling the program that the input is in text file format
\item[] \texttt{--iscsv}\\Boolean telling the program that the input is in CSV format
\end{itemize}

Only specify one of the Boolean flags! (This program currently does not have the capability to handle multiple formats.)

The following flags are optional:
\begin{itemize}
\item[] \texttt{--rtable OUTPUT}\\ File name for output RData file. The result will be an RData table containing the data frame \texttt{df\_data}.
\item[] \texttt{--texttable OUTPUT}\\ File name for output text file with tab-separated columns.
\item[] \texttt{--csvtable OUTPUT}\\File name for output CSV file. 
\end{itemize}


\subsection{Function syntax}
To load this function in an interactive R session, do
\begin{verbatim}
source("combine_tables.R")
desired_name<-combine_dfs(flist,ftype,...)
\end{verbatim}

which will combine the loaded \texttt{data.frame} objects from each file into a single \texttt{data.frame} object with the variable name \texttt{desired\_name}.

The following arguments are required:
\begin{itemize}
\item[] \texttt{flist}\\ a vector object containing the BlobStats file names.
\item[] \texttt{ftype}\\ File format of input files (specify one of three strings: \texttt{"R"}, \texttt{"text"}, or \texttt{"CSV"})
\end{itemize}

The following arguments are optional:
\begin{itemize}
\item[] \texttt{rfn, textfn, csvfn}\\Strings specifying output file names for RData, text, and CSV file formats. If left blank, the function will merely return the \texttt{data.frame} object to the console.
\end{itemize}

\subsection{Output}
The output is identical to that seen in Section \ref{tableoutput}, but column values for the \texttt{var} column might vary.

\section{Create a per-blob summary table}
This utility reads in a data table (using the method outlined in Section \ref{combinetable}) and creates a table that provides per-blob information on quantities such a the blob's starting and ending centroid coordinates, the blob's duration in days, and others described in more detail below.  There is optional functionality to save the output to one of three file types (RData, text, or CSV).

\subsection{Command line syntax}
\begin{verbatim}
Rscript --vanilla stitch_metric_framework.R [-st] [-rt] [-fn or -fl FILE] 
[--isr or --istext or --iscsv]

(optional)
[--rsumm OUTPUT] [--textsumm OUTPUT] [--csvsumm OUTPUT]
\end{verbatim}

The following flags are required:
\begin{itemize}
\item[] \texttt{-st} (\texttt{--summarize})\\ Tell program to summarize the data table output(s) from reading in BlobStats data.
\item[] \texttt{-rt} (\texttt{--readtable}) \\ Tell program to read in BlobStats data.
\item[]\texttt{-fn} (\texttt{--filename}) or \texttt{-fl} (\texttt{--filelist}) \texttt{FILE}\\ Name of single file containing output from \texttt{--readfiles}, or a text file containing a list of files with output from \texttt{--readfiles}.
\item[]\texttt{--isr}\\Boolean telling the program that the input is in RData format
\item[]\texttt{--istext}\\Boolean telling the program that the input is in text file format
\item[] \texttt{--iscsv}\\Boolean telling the program that the input is in CSV format
\end{itemize}

Only specify one of the Boolean flags! (This program currently does not have the capability to handle multiple formats.)

The following flags are optional:
\begin{itemize}
\item[] \texttt{--rsumm OUTPUT}\\ File name for output RData file. The result will be an RData table containing the data frame \texttt{df\_summ}.
\item[] \texttt{--textsumm OUTPUT}\\ File name for output text file with tab-separated columns.
\item[] \texttt{--csvsumm OUTPUT}\\File name for output CSV file. 
\end{itemize}

\subsection{Function syntax}
To load this function in an interactive R session, do
\begin{verbatim}
source("summ_table.R")
desired_name<-gen_summary_table(df_in,...)
\end{verbatim}

which will summarize each unique blob in the input \texttt{data.frame} object and produce an output \texttt{data.frame} object with the variable name \texttt{desired\_name}.

The following arguments are required:
\begin{itemize}
\item[] \texttt{df\_in}\\ Name of the input data frame.
\end{itemize}

The following arguments are optional:
\begin{itemize}
\item[] \texttt{rfn, textfn, csvfn}\\Strings specifying output file names for RData, text, and CSV file formats. If left blank, the function will merely return the \texttt{data.frame} object to the console.
\end{itemize}

\subsection{Output}
An example summary table looks like this in the R console:
\begin{verbatim}
            startdate             enddate duration_days start_centlat start_centlon end_centlat
1 1980-12-01 00:00:00 1980-12-13 18:00:00         12.75          61.0         202.5        57.0
2 1980-12-14 06:00:00 1980-12-29 18:00:00         15.50          43.5         239.5        57.0

  end_centlon  dist_km zonal_dist_km zonal_speed_kph min_area  max_area avg_area bnum
1       152.5 2825.715     2932.1134        9.582070 24503497 105945491 48812899    1
2       144.0 6377.548     5347.1906       14.374168 13394293  93958976 48812899    2

                         file
1 ERA_1980_DJF_NP_Z_stats.txt
2 ERA_1980_DJF_NP_Z_stats.txt
\end{verbatim}

\begin{appendix}
\section{BlobStats File Format}
Each BlobStats file is formatted as follows:\begin{itemize}
\item[] Line 1: Date of first time step in format \texttt{YYYY-MM-DD}
\item[] Line 2: Tab-separated column names 
\item[]Blob information line: \texttt{Blob IDNUM (NUM\_TIMESTEPS)} where \texttt{IDNUM} is the blob's unique identifier number and \texttt{NUM\_TIMESTEPS} is the number of timesteps in the blob's lifespan.
\item[] Per-timestep blob information: Always contains the timestep number in column 1. The other columns depend on the included variables. 
\end{itemize}

For example, a BlobStats file with two Blobs, each with a lifetime of 2 time steps, would look like this:

\begin{verbatim}
1980-12-01
Time    minlat  maxlat  minlon  maxlon  centlat centlon area
Blob 1 (2)
1       50.00000        74.00000        187.00000       222.00000       62.00000        204.50000       0.00898
2       45.00000        75.00000        139.00000       226.00000       60.00000        182.50000       0.01230
Blob 2 (2)
53      39.00000        48.00000        226.00000       253.00000       43.50000        239.50000       0.00456
54      36.00000        49.00000        221.00000       254.00000       42.50000        237.50000       0.00751
\end{verbatim}
\end{appendix}


\end{document}
